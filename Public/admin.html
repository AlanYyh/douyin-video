<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0f0f0f; color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; min-height: 100vh; }
        .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: #1a1a1a; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; }
        .login-title { font-size: 24px; text-align: center; margin-bottom: 32px; font-weight: 600; }
        .form-input { width: 100%; height: 48px; background: #2a2a2a; border: 1px solid #333; border-radius: 8px; padding: 0 16px; color: #fff; font-size: 15px; margin-bottom: 16px; outline: none; }
        .form-input:focus { border-color: #fe2c55; }
        .form-btn { width: 100%; height: 48px; background: #fe2c55; border: none; border-radius: 8px; color: #fff; font-size: 16px; font-weight: 500; cursor: pointer; }
        .form-btn:hover { opacity: 0.9; }
        .admin-page { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .header h1 { font-size: 22px; }
        .logout-btn { background: #333; border: none; color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .logout-btn:hover { background: #444; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1a1a1a; border-radius: 12px; padding: 24px; text-align: center; }
        .stat-value { font-size: 36px; font-weight: 700; color: #fe2c55; margin-bottom: 8px; }
        .stat-label { font-size: 14px; color: #888; }
        .section { background: #1a1a1a; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .section-title { font-size: 18px; margin-bottom: 20px; color: #fe2c55; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        .table th { color: #888; font-weight: 500; font-size: 13px; }
        .table td { font-size: 14px; }
        .table tr:hover { background: #222; }
        .category-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .category-tag { background: #2a2a2a; padding: 8px 16px; border-radius: 20px; font-size: 13px; }
        .category-tag span { color: #fe2c55; font-weight: 600; margin-left: 8px; }
        .tips { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 14px; opacity: 0; transition: opacity 0.3s; z-index: 100; }
        .tips.show { opacity: 1; }
        .video-link { color: #aaa; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
        .upload-area { border: 2px dashed #444; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        .upload-area:hover { border-color: #fe2c55; background: rgba(254,44,85,0.1); }
        .upload-area.dragover { border-color: #fe2c55; background: rgba(254,44,85,0.2); }
        .upload-icon { font-size: 48px; margin-bottom: 16px; }
        .upload-text { color: #888; font-size: 14px; }
        .upload-input { display: none; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .video-card { background: #2a2a2a; border-radius: 8px; overflow: hidden; position: relative; }
        .video-card video { width: 100%; height: 120px; object-fit: cover; background: #000; }
        .video-card-info { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .video-name { font-size: 12px; color: #888; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .delete-btn { background: #fe2c55; border: none; color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .delete-btn:hover { opacity: 0.8; }
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #2a2a2a; border: none; color: #888; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .tab-btn.active { background: #fe2c55; color: #fff; }
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <div class="login-box">
            <div class="login-title">åå°ç®¡ç†ç™»å½•</div>
            <input type="password" class="form-input" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç ">
            <button class="form-btn" id="loginBtn">ç™»å½•</button>
        </div>
    </div>
    <div class="admin-page" id="adminPage">
        <div class="header">
            <h1>æ•°æ®ç»Ÿè®¡åå°</h1>
            <button class="logout-btn" id="logoutBtn">é€€å‡º</button>
        </div>
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="stats">æ•°æ®ç»Ÿè®¡</button>
            <button class="tab-btn" data-tab="night">æ·±å¤œè§†é¢‘ç®¡ç†</button>
            <button class="tab-btn" data-tab="settings">ç³»ç»Ÿè®¾ç½®</button>
        </div>
        
        <div id="statsTab">
            <div class="stats-grid" id="statsGrid"></div>
            <div class="section">
                <div class="section-title">å„ç±»å‹è§‚çœ‹ç»Ÿè®¡</div>
                <div class="category-list" id="categoryStats"></div>
            </div>
            <div class="section">
                <div class="section-title">ç”¨æˆ·è§‚çœ‹æ’è¡Œ</div>
                <table class="table">
                    <thead><tr><th>ç”¨æˆ·å</th><th>è§‚çœ‹æ¬¡æ•°</th></tr></thead>
                    <tbody id="userStats"></tbody>
                </table>
            </div>
            <div class="section">
                <div class="section-title">æœ€è¿‘æ”¶è—è®°å½•</div>
                <table class="table">
                    <thead><tr><th>ç”¨æˆ·å</th><th>è§†é¢‘ç±»å‹</th><th>è§†é¢‘é“¾æ¥</th><th>æ”¶è—æ—¶é—´</th></tr></thead>
                    <tbody id="recentFavorites"></tbody>
                </table>
            </div>
        </div>
        
        <div id="nightTab" style="display:none;">
            <div class="section">
                <div class="section-title">æ·±å¤œåˆ†ç±»è®¿é—®å¯†ç è®¾ç½®</div>
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:20px;">
                    <input type="text" id="nightPasswordInput" class="form-input" style="flex:1;margin:0;" placeholder="è®¾ç½®è®¿é—®å¯†ç ">
                    <button id="savePasswordBtn" class="btn" style="padding:0 20px;height:44px;white-space:nowrap;">ä¿å­˜å¯†ç </button>
                </div>
                <p style="color:#888;font-size:12px;margin:0;">ç”¨æˆ·ç‚¹å‡»"æ·±å¤œ"åˆ†ç±»æ—¶éœ€è¦è¾“å…¥æ­¤å¯†ç æ‰èƒ½è®¿é—®</p>
            </div>
            <div class="section">
                <div class="section-title">ä¸Šä¼ æ·±å¤œè§†é¢‘ <span id="nightCount" style="color:#888;font-size:14px;"></span></div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“¹</div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ <br>æ”¯æŒ mp4, webm, mov æ ¼å¼</div>
                    <input type="file" class="upload-input" id="uploadInput" accept="video/mp4,video/webm,video/quicktime" multiple>
                </div>
                <div class="video-grid" id="nightVideos"></div>
            </div>
        </div>
        
        <div id="settingsTab" style="display:none;">
            <div class="section">
                <div class="section-title">ä¿®æ”¹åå°ç®¡ç†å¯†ç </div>
                <input type="password" id="oldAdminPassword" class="form-input" placeholder="åŸå¯†ç ">
                <input type="password" id="newAdminPassword" class="form-input" placeholder="æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                <input type="password" id="confirmAdminPassword" class="form-input" placeholder="ç¡®è®¤æ–°å¯†ç ">
                <button id="saveAdminPasswordBtn" class="form-btn" style="max-width:200px;">ä¿å­˜å¯†ç </button>
            </div>
        </div>
    </div>
    <div class="tips" id="tips"></div>
    <script>
        const CATEGORY_NAMES = {
            all: 'å…¨éƒ¨', jk: 'JKåˆ¶æœ', baisi: 'ç™½ä¸', heisi: 'é»‘ä¸', chuanda: 'ç©¿æ­',
            gaozhiliang: 'é«˜è´¨é‡', qingchun: 'æ¸…çº¯', rewu: 'çƒ­èˆ', nvda: 'å¥³å¤§', shejie: 'å¾¡å§', night: 'æ·±å¤œ'
        };

        const loginPage = document.getElementById('loginPage');
        const adminPage = document.getElementById('adminPage');
        const adminPassword = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const tips = document.getElementById('tips');
        const statsGrid = document.getElementById('statsGrid');
        const categoryStats = document.getElementById('categoryStats');
        const userStats = document.getElementById('userStats');
        const recentFavorites = document.getElementById('recentFavorites');

        function showTips(msg) {
            tips.textContent = msg;
            tips.classList.add('show');
            setTimeout(() => tips.classList.remove('show'), 2000);
        }

        function formatTime(str) {
            if (!str) return '-';
            const d = new Date(str);
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        async function loadStats() {
            const res = await fetch('/api/admin/stats');
            const data = await res.json();
            if (!data.success) return;

            statsGrid.innerHTML = `
                <div class="stat-card"><div class="stat-value">${data.totalUsers}</div><div class="stat-label">æ³¨å†Œç”¨æˆ·</div></div>
                <div class="stat-card"><div class="stat-value">${data.totalWatches}</div><div class="stat-label">æ€»è§‚çœ‹æ¬¡æ•°</div></div>
                <div class="stat-card"><div class="stat-value">${data.totalFavorites}</div><div class="stat-label">æ€»æ”¶è—æ•°</div></div>
            `;

            categoryStats.innerHTML = data.categoryStats.map(c => `
                <div class="category-tag">${CATEGORY_NAMES[c.category] || c.category}<span>${c.count}</span></div>
            `).join('');

            userStats.innerHTML = data.userStats.map(u => `
                <tr><td>${u.username || 'æ¸¸å®¢'}</td><td>${u.watch_count}</td></tr>
            `).join('');

            recentFavorites.innerHTML = data.recentFavorites.map(f => `
                <tr>
                    <td>${f.username}</td>
                    <td>${CATEGORY_NAMES[f.category] || f.category || '-'}</td>
                    <td><a class="video-link" href="${f.video_url}" target="_blank">${f.video_url}</a></td>
                    <td>${formatTime(f.created_at)}</td>
                </tr>
            `).join('');
        }

        loginBtn.addEventListener('click', async () => {
            const password = adminPassword.value;
            const res = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await res.json();
            if (data.success) {
                loginPage.style.display = 'none';
                adminPage.style.display = 'block';
                loadStats();
            } else {
                showTips(data.message);
            }
        });

        adminPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        logoutBtn.addEventListener('click', () => {
            loginPage.style.display = 'flex';
            adminPage.style.display = 'none';
            adminPassword.value = '';
        });

        const tabBtns = document.querySelectorAll('.tab-btn');
        const statsTab = document.getElementById('statsTab');
        const nightTab = document.getElementById('nightTab');
        const settingsTab = document.getElementById('settingsTab');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                statsTab.style.display = 'none';
                nightTab.style.display = 'none';
                settingsTab.style.display = 'none';
                if (btn.dataset.tab === 'stats') {
                    statsTab.style.display = 'block';
                } else if (btn.dataset.tab === 'night') {
                    nightTab.style.display = 'block';
                    loadNightVideos();
                    loadNightPassword();
                } else if (btn.dataset.tab === 'settings') {
                    settingsTab.style.display = 'block';
                }
            });
        });

        const uploadArea = document.getElementById('uploadArea');
        const uploadInput = document.getElementById('uploadInput');
        const nightVideos = document.getElementById('nightVideos');
        const nightCount = document.getElementById('nightCount');
        const nightPasswordInput = document.getElementById('nightPasswordInput');
        const savePasswordBtn = document.getElementById('savePasswordBtn');
        
        async function loadNightPassword() {
            try {
                const res = await fetch('/api/admin/night-password');
                const data = await res.json();
                if (data.success) {
                    nightPasswordInput.value = data.password || '';
                }
            } catch (e) {}
        }
        
        savePasswordBtn.addEventListener('click', async () => {
            const password = nightPasswordInput.value.trim();
            if (!password) {
                showTips('å¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            try {
                const res = await fetch('/api/admin/night-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (data.success) {
                    showTips('å¯†ç å·²ä¿å­˜');
                } else {
                    showTips(data.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                showTips('ä¿å­˜å¤±è´¥');
            }
        });

        uploadArea.addEventListener('click', () => uploadInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        uploadInput.addEventListener('change', () => handleFiles(uploadInput.files));

        async function handleFiles(files) {
            for (const file of files) {
                if (!file.type.startsWith('video/')) continue;
                showTips('æ­£åœ¨ä¸Šä¼ : ' + file.name);
                const formData = new FormData();
                formData.append('video', file);
                try {
                    const res = await fetch('/api/night/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.success) {
                        showTips('ä¸Šä¼ æˆåŠŸ');
                        loadNightVideos();
                    } else {
                        showTips('ä¸Šä¼ å¤±è´¥: ' + data.message);
                    }
                } catch (e) {
                    showTips('ä¸Šä¼ å¤±è´¥');
                }
            }
            uploadInput.value = '';
        }

        async function loadNightVideos() {
            const res = await fetch('/api/night/list');
            const data = await res.json();
            nightCount.textContent = `(å…± ${data.count} ä¸ªè§†é¢‘)`;
            if (data.videos.length === 0) {
                nightVideos.innerHTML = '<div style="color:#888;text-align:center;padding:40px;">æš‚æ— è§†é¢‘ï¼Œè¯·ä¸Šä¼ </div>';
                return;
            }
            nightVideos.innerHTML = data.videos.map((v, i) => {
                const uploadTime = new Date(v.uploadTime);
                const timeStr = `${uploadTime.getFullYear()}-${String(uploadTime.getMonth()+1).padStart(2,'0')}-${String(uploadTime.getDate()).padStart(2,'0')} ${String(uploadTime.getHours()).padStart(2,'0')}:${String(uploadTime.getMinutes()).padStart(2,'0')}`;
                return `
                <div class="video-card">
                    <video src="/night-videos/${v.filename}" muted></video>
                    <div class="video-card-info">
                        <span class="video-name">è§†é¢‘ ${i + 1} - ${timeStr}</span>
                        <button class="delete-btn" data-name="${v.filename}">åˆ é™¤</button>
                    </div>
                </div>
            `;
            }).join('');
            
            nightVideos.querySelectorAll('video').forEach(v => {
                v.addEventListener('mouseenter', () => v.play());
                v.addEventListener('mouseleave', () => { v.pause(); v.currentTime = 0; });
            });
            
            nightVideos.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤è§†é¢‘ï¼Ÿ')) return;
                    const res = await fetch('/api/night/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: btn.dataset.name })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showTips('å·²åˆ é™¤');
                        loadNightVideos();
                    } else {
                        showTips('åˆ é™¤å¤±è´¥');
                    }
                });
            });
        }
        
        const saveAdminPasswordBtn = document.getElementById('saveAdminPasswordBtn');
        saveAdminPasswordBtn.addEventListener('click', async () => {
            const oldPassword = document.getElementById('oldAdminPassword').value;
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            if (!oldPassword || !newPassword || !confirmPassword) {
                showTips('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            if (newPassword.length < 6) {
                showTips('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            if (newPassword !== confirmPassword) {
                showTips('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            try {
                const res = await fetch('/api/admin/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword, newPassword })
                });
                const data = await res.json();
                if (data.success) {
                    showTips('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
                    document.getElementById('oldAdminPassword').value = '';
                    document.getElementById('newAdminPassword').value = '';
                    document.getElementById('confirmAdminPassword').value = '';
                    setTimeout(() => {
                        loginPage.style.display = 'flex';
                        adminPage.style.display = 'none';
                    }, 1500);
                } else {
                    showTips(data.message || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (e) {
                showTips('ä¿®æ”¹å¤±è´¥');
            }
        });
    </script>
</body>
</html>
